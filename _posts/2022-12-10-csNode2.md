---
layout: single
title: "[Node.js] Mini-Node-Server"
categories: Node.js
tags: [ Node.js, CodeStates]
toc: true


---

### 2022.12.10

### ğŸ’¡  Mini-Node-Server

#### ğŸ“Œ ì°¸ê³ í•œ ìë£Œ 

[HTTP íŠ¸ëœì­ì…˜ í•´ë¶€](https://nodejs.org/ko/docs/guides/anatomy-of-an-http-transaction/)

####   ğŸ‘¨ğŸ»â€ğŸ’» ì„œë²„ ìƒì„±

```js
const http = require('http');
const PORT = '5000';
const ip = 'localhost';

const server = http.createServer((request, response) => {

})
```

- ëª¨ë“  node ì›¹ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ `createServer`ë¥¼ ì´ìš©í•˜ì—¬ ì›¹ ì„œë²„ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤.
- ì´ ì„œë²„ë¡œ ì˜¤ëŠ” HTTP ìš”ì²­ë§ˆë‹¤ `createServer`ì— ì „ë‹¬ëœ í•¨ìˆ˜ê°€ í•œ ë²ˆì”© í˜¸ì¶œëœë‹¤.
- HTTP ìš”ì²­ì´ ì„œë²„ì— ì˜¤ë©´ nodeê°€ íŠ¸ëœì­ì…˜ì„ ë‹¤ë£¨ë ¤ê³  `request`ì™€ `response` ê°ì²´ë¥¼ ì „ë‹¬í•˜ë©° ìš”ì²­ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.

```js
server.listen(PORT, ip, () => {
  console.log(`http server listen on ${ip}:${PORT}`);
});
//or
server.listen(PORT);
```

- ìš”ì²­ì„ ì‹¤ì œë¡œ ì²˜ë¦¬í•˜ë ¤ë©´ `listen` ë©”ì„œë“œê°€ `server` ê°ì²´ì—ì„œ í˜¸ì¶œë˜ì–´ì•¼ í•œë‹¤. ëŒ€ë¶€ë¶„ì€ ì„œë²„ê°€ ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” í¬íŠ¸ ë²ˆí˜¸ë¥¼ `listen`ì— ì „ë‹¬í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.

#### routing

> routing?
>
> - ê²½ë¡œë¥¼ ì°¾ì•„ê°€ê²Œ í•˜ëŠ” ê³¼ì •
>
> routing protocol
>
> - ì°¾ì•„ì£¼ëŠ” ê·œì¹™ ì‚¬ìš©í•˜ëŠ” í”„ë¡œí† ì½œ

```js
const defaultCorsHeader = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Accept',
  'Access-Control-Max-Age': 10
};
const server = http.createServer((request, response) => {
  if (request.method === 'OPTIONS') {
    // 1.OPTIONS ë©”ì†Œë“œê°€ ì˜¤ëŠ” ê²½ìš° 
    response.writeHead(200, defaultCorsHeader);
    response.end('hello mini-server sprints');
  }
  if (request.method === 'POST' && request.url === '/upper') {
 	// 2.POST ë©”ì†Œë“œì™€ end pointê°€ /upperì¼ ë•Œ
    let body = [];
    request.on('data', (chunk) => { //ê° data ì´ë²¤íŠ¸ì—ì„œ ë°œìƒì‹œí‚¨ ì²­í¬ëŠ” Bufferë‹¤.
      body.push(chunk);//ì²­í¬ë¥¼ ë°°ì—´ì— ëª¨ì•„ë‘”ë‹¤.
    }).on('end', () => { 
      body = Buffer.concat(body).toString();// end ì´ë²¤íŠ¸ì—ì„œ ì´ì–´ ë¶™ì¸ ë‹¤ìŒ ë¬¸ìì—´ë¡œ ë§Œë“ ë‹¤.
      response.writeHead(200, defaultCorsHeader);
      response.end(body.toUpperCase()); //responseê°ì²´ë¥¼ ë³´ë‚¼ ë•Œ í•´ë‹¹ ë°ì´í„°ë¥¼ ë„£ì–´ ë³´ë‚¸ë‹¤.
    });    
  } else if (request.method === 'POST' && request.url === '/lower') {
   	// 3.POST ë©”ì†Œë“œì™€ end pointê°€ /lower ë•Œ
     let body = [];
    request.on('data', (chunk) => {
      body.push(chunk);
    }).on('end', () => {
      body = Buffer.concat(body).toString();
      response.writeHead(200, defaultCorsHeader); //CORS
      response.end(body.toLowerCase());
    });   
  } else {  
    // 4.ì—ëŸ¬ì²˜ë¦¬
    response.statusCode = 404;
    response.end();
  }
})
```

1. OPTIONS ë©”ì†Œë“œê°€ ì˜¤ëŠ” ê²½ìš°

- `OPTIONS` ë©”ì†Œë“œë¡œ ìš”ì²­ì´ ì˜¤ëŠ” ê²½ìš°ëŠ” í•´ë‹¹ ìš”ì²­ì´ `preflight request`ì¸ ê²½ìš°ë‹¤. ì´ ìš”ì²­ì„ ë°›ì€ ê²½ìš° ì„œë²„ëŠ” ìš”ì²­ ìˆ˜ë½ ì—¬ë¶€ë¥¼ ê²°ì •í•œ ë’¤ ì ‘ê·¼ ê°€ëŠ¥í•œ ì¡°ê±´ì„ ì•Œë ¤ì¤€ë‹¤. ê·¸ëŸ¬ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ì— ìš”ì²­ì„ í• ì§€ ë§ì§€ ê²°ì •í•œë‹¤.

2.3. POST ë©”ì†Œë“œì™€ end pointê°€ /upper or /lower ì¼ ë•Œ

- í´ë¼ì´ì–¸íŠ¸ì—ì„œ `POST` + `/upper` ë¡œ ìš”ì²­ì„ í•œ ê²½ìš°ë‹¤. `request`ëŠ” `ReadableStream` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³  ìˆë‹¤. ìŠ¤íŠ¸ë¦¼ì˜ `'data'`ì™€ `'end'` ì´ë²¤íŠ¸ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•´ì„œ ë°ì´í„°ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.

1. ì—ëŸ¬ì²˜ë¦¬

- ìš”ì²­ì´ ì˜¬ë°”ë¥´ê²Œ ë˜ì§€ ì•Šì€ ê²½ìš° `response` ê°ì²´ì— `statusCode`ë¥¼ ë‹´ê³  ì‘ë‹µì„ ë³´ë‚¸ë‹¤.

### CORS ì ìš©í•´ë³´ê¸°

- í˜„ì¬ ì‘ì—…í•˜ëŠ” í™˜ê²½ì€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ëª¨ë‘ ë¡œì»¬ì—ì„œ ì´ë£¨ì–´ì§€ê³  ìˆë‹¤. CORSë¥¼ ì ìš©í•´ë³´ê¸° ìœ„í•´ [serve ìœ í‹¸ë¦¬í‹°](https://github.com/vercel/serve)ë¥¼ ì´ìš©í•´ ê°€ìƒì˜ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ê³  CORSë¥¼ ì ìš©í•´ë³¸ë‹¤.
- `$ npx serve client/ -l 1234` ë¡œ ê°€ìƒì˜ í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•œë‹¤.
  ![img](https://velog.velcdn.com/images%2Fjing07161%2Fpost%2Ff44170d8-8c51-4d43-b8db-c1df1756dcd1%2Fimage.png)
- ê·¸ ë‹¤ìŒ, ì„œë²„ì˜ `Access-Control-Allow-Origin`ì„ í´ë¼ì´ì–¸íŠ¸ì˜ ë°©ê¸ˆ ë§Œë“  í´ë¼ì´ì–¸íŠ¸ë¡œ ì§€ì •í•œë‹¤. (í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ë§Œ ì„œë²„ì— ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ê¸° ìœ„í•¨)

```js
const defaultCorsHeader = {
  'Access-Control-Allow-Origin': 'http://localhost:1234',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Accept',
  'Access-Control-Max-Age': 10
};
```

- `http://localhost:1234`ì— ì ‘ì†í•œ ë’¤, `POST` ìš”ì²­ì„ í•œ ê²½ìš° ëœë‹¤ë©´ CORS ì ìš©ì´ ì˜ ëœ ê²ƒ.
  ![img](https://velog.velcdn.com/images%2Fjing07161%2Fpost%2Fa06d8ef2-a4d4-4c37-91a0-e0928c21bdda%2Fimage.png)
- ìœ„ ì‚¬ì§„ì€ `preflight request` ì´í›„ `POST` ìš”ì²­ê¹Œì§€ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ê²½ìš°ë‹¤.
- ë§Œì•½ ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ì¸ `http://localhost:5000`ì— ì ‘ì†í•œ ë’¤, `POST` ìš”ì²­ì„ í•œ ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•´ì•¼ ì •ìƒ
  ![img](https://velog.velcdn.com/images%2Fjing07161%2Fpost%2F99c63064-9570-4e9a-be1e-e784ee8a1494%2Fimage.png)
  ![img](https://velog.velcdn.com/images%2Fjing07161%2Fpost%2F738e6040-8a54-4d02-85ea-45ec8e0c422f%2Fimage.png)
- ì˜ˆìƒí•œëŒ€ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ì—ëŸ¬ì˜ ë‚´ìš©ì„ ë³´ë©´ ì‹¤ì œë¡œ CORS policy ì •ì±…ì— ì˜í•´ ë§‰í˜”ë‹¤ê³  ë‚˜ì˜¨ë‹¤.

------

- ë‹¤ìŒì€ `preflight request` ë§ê³  `single request`ë¡œ ìš”ì²­í•˜ë„ë¡ ë³€ê²½í•˜ëŠ” ì‘ì—…ì„ í•´ë³´ê² ë‹¤.
  `single request`ê°€ ë˜ê¸° ìœ„í•´ì„  ì—¬ëŸ¬ ì¡°ê±´ì´ ìˆëŠ”ë° ì¡°ê±´ ì¤‘ í•˜ë‚˜ì¸ `'Content-Type' : 'text/plain'` ìœ¼ë¡œ ë³€ê²½í•´ ë³´ê² ë‹¤.

```js
 post(path, body) {
    fetch(`http://localhost:5000/${path}`, {
      method: 'POST',
      body: JSON.stringify(body),
      headers: {
        'Content-Type': 'text/plain' 
      }
    })
      .then(res => res.json())
      .then(res => {
        this.render(res);
      });
  }
```

- ìœ„ì™€ ê°™ì´ ë³€ê²½í•˜ê³  ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚¸ ê²½ìš° `OPTIONS` ìš”ì²­ì€ ê±´ë„ˆë›°ê³  `POST`ìš”ì²­ì´ ë°”ë¡œ ì „ë‹¬ëœë‹¤.

![img](https://velog.velcdn.com/images%2Fjing07161%2Fpost%2F871eb84b-3e7f-4823-8678-6559ac02b7aa%2Fimage.png)

- ìœ„ ì‚¬ì§„ê³¼ ê°™ì´ `/upper`ë¡œ `POST` ìš”ì²­ì´ í•˜ë‚˜ë§Œ ê°„ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

### ê¶ê¸ˆí–ˆë˜ ì 

------

> `preflight request`ë¥¼ ë³´ë‚´ì„œ ì„œë²„ì—ì„œ ìš”ì²­ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸ í•œ ë’¤, ìš”ì²­ì´ ê°€ëŠ¥í•˜ë‹¤ë©´ `POST` ìš”ì²­ì„ í•˜ëŠ”ë° ì´ ë•Œ ì‘ë‹µ í—¤ë”ì— CORS ê´€ë ¨ í—¤ë”ë¥¼ ë¶™ì—¬ì•¼ í•˜ëŠ”ê°€?

ì˜ˆì‹œ ì½”ë“œ

```js
const defaultCorsHeader = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Accept',
  'Access-Control-Max-Age': 10
};
if (request.method === 'POST' && request.url === '/upper') {
    //ëŒ€ë¬¸ìë¡œ ì‘ë‹µì„ ëŒë ¤ì¤˜ì•¼ í•œë‹¤
    let body = [];
    request.on('data', (chunk) => {
      body.push(chunk);
    }).on('end', () => {
      body = Buffer.concat(body).toString();
      response.writeHead(200, defaultCorsHeader); // POST ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µ í—¤ë”ì— CORS ê´€ë ¨ í—¤ë”ë¥¼ ë¶™ì—¬ì£¼ê³  ìˆë‹¤.
      response.end(body.toUpperCase());
    });
```

#### í•´ê²°

[CORS ê´€ë ¨ MDN](https://developer.mozilla.org/ko/docs/Web/HTTP/CORS)ì— ë³´ë©´ `preflight request` ë¥¼ í•œ ê²½ìš° ìš”ì²­, ì‘ë‹µ ì½”ë“œë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.

```null
<preflight request>

OPTIONS /resources/post-here/ HTTP/1.1
Host: bar.other
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko/20100101 Firefox/71.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
Origin: http://foo.example
```

**Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER, Content-Type**

> Access-Control-Request-Method í—¤ë”ëŠ” preflight requestì˜ ì¼ë¶€ë¡œ, ì‹¤ì œ ìš”ì²­ì„ ì „ì†¡í•  ë•Œ POST ë©”ì„œë“œë¡œ ì „ì†¡ëœë‹¤ëŠ” ê²ƒì„ ì•Œë ¤ì¤ë‹ˆë‹¤. Access-Control-Request-Headers í—¤ë”ëŠ” ì‹¤ì œ ìš”ì²­ì„ ì „ì†¡ í•  ë•Œ X-PINGOTHER ì™€ Content-Type ì‚¬ìš©ì ì •ì˜ í—¤ë”ì™€ í•¨ê»˜ ì „ì†¡ëœë‹¤ëŠ” ê²ƒì„ ì„œë²„ì— ì•Œë ¤ì¤ë‹ˆë‹¤.

```null
<preflight request ì‘ë‹µ>

HTTP/1.1 204 No Content
Date: Mon, 01 Dec 2008 01:15:39 GMT
Server: Apache/2 
```

**Access-Control-Allow-Origin: [https://foo.example](https://foo.example/)
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
Access-Control-Max-Age: 86400**

> ì„œë²„ëŠ” Access-Control-Allow-Methods ë¡œ ì‘ë‹µí•˜ê³  POST ì™€ GET ì´ ë¦¬ì†ŒìŠ¤ë¥¼ ì¿¼ë¦¬í•˜ëŠ”ë° ìœ ìš©í•œ ë©”ì„œë“œë¼ê³  ê°€ë¥´ì³ì¤ë‹ˆë‹¤. ì´ í—¤ë”ëŠ” Allow ì‘ë‹µ í—¤ë”ì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ì ‘ê·¼ ì œì–´ ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„œ ì—„ê²©í•˜ê²Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
> ë˜í•œ Access-Control-Allow-Headers ì˜ ê°’ì„ "X-PINGOTHER, Content-Type" ìœ¼ë¡œ ì „ì†¡í•˜ì—¬ ì‹¤ì œ ìš”ì²­ì— í—¤ë”ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤. Access-Control-Allow-Methodsì™€ ë§ˆì°¬ê°€ì§€ë¡œ Access-Control-Allow-Headers ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„ëœ í—ˆìš© ê°€ëŠ¥í•œ í—¤ë” ëª©ë¡ì…ë‹ˆë‹¤.

```null
Vary: Accept-Encoding, Origin
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
<preflight request ì™„ë£Œ í›„ ì‹¤ì œ ìš”ì²­>

POST /resources/post-here/ HTTP/1.1
Host: bar.other
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:71.0) Gecko/20100101 Firefox/71.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
X-PINGOTHER: pingpong
Content-Type: text/xml; charset=UTF-8
Referer: https://foo.example/examples/preflightInvocation.html
Content-Length: 55
Origin: https://foo.example
Pragma: no-cache
Cache-Control: no-cache

<person><name>Arun</name></person>


<preflight request ì™„ë£Œ í›„ ì‹¤ì œ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µ>

HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 01:15:40 GMT
Server: Apache/2
```

**Access-Control-Allow-Origin: [https://foo.example](https://foo.example/)**

> `preflight request` ì´í›„ POST ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µ í—¤ë”ì—ë„ Originì´ ì¶”ê°€ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.   
> ì´ì²˜ëŸ¼ ë‹¤ë¥¸ í—¤ë”ëŠ” í¬í•¨ì‹œí‚¤ì§€ ì•Šë”ë¼ë„ `Access-Control-Allow-Origin` ì— ê´€í•œ ì½”ë“œëŠ” ì‘ë‹µ í—¤ë”ì— ë„£ì–´ì¤˜ì„œ ì–´ëŠ Originì´ í—ˆìš©ë˜ëŠ”ì§€ ëª…ì‹œí•´ì¤˜ì•¼ í•œë‹¤.

```null
Vary: Accept-Encoding, Origin
Content-Encoding: gzip
Content-Length: 235
Keep-Alive: timeout=2, max=99
Connection: Keep-Alive
Content-Type: text/plain

[Some GZIP'd payload]
```

ì •ë¦¬í•˜ìë©´, `preflight request`ë¥¼ í†µí•´ ìš”ì²­ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ë”ë¼ë„ ì‹¤ì œ ìš”ì²­ ì‘ë‹µ í—¤ë”ì—” í—ˆìš© `Origin`ì„ ì ì–´ì¤˜ì•¼ í•œë‹¤.